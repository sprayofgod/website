<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spray of God</title>
  <style>
    :root{
      --reveal-delay: 5500ms; /* 5–7 c */
      --fade-duration: 700ms;
      --text-bg: rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:#000;color:#fff;overflow:hidden}

    .stage{position:fixed;inset:0;overflow:hidden;}

    /* Loader (только до первого старта) */
    .loader{position:absolute;inset:0;display:grid;place-items:center;background:#000;z-index:60;transition:opacity var(--fade-duration) ease;}
    .loader.hidden{opacity:0;pointer-events:none}
    .spinner{width:56px;height:56px;border-radius:50%;border:4px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Tap-to-play (если автоплей заблокирован) */
    .tap{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:70}
    .tap.visible{display:grid}
    .tap-btn{cursor:pointer;border:1px solid rgba(255,255,255,.6);padding:12px 18px;border-radius:12px;background:rgba(0,0,0,.35)}
    .tap-btn:active{transform:scale(.98)}

    /* Video + freeze */
    .bg-video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;background:#000;}
    canvas.freeze{position:absolute;inset:0;width:100%;height:100%;display:none}

    /* Logo */
    .logo{position:absolute;inset:0;display:grid;place-items:center;z-index:20;opacity:0;pointer-events:none;transition:opacity var(--fade-duration) ease,transform var(--fade-duration) ease;}
    .logo.visible{opacity:1;pointer-events:auto}
    .logo img{width:50%;height:auto;object-fit:contain;filter:drop-shadow(0 6px 18px rgba(0,0,0,.55));cursor:pointer;}
    .logo.fading{opacity:0;transform:scale(.96)}

    /* Reveal image */
    .reveal{position:absolute;inset:0;background:#000 center/cover no-repeat;opacity:0;transition:opacity var(--fade-duration) ease;z-index:10;cursor:pointer}
    .reveal.visible{opacity:1}

    /* Bottom text */
    .cta{position:absolute;left:0;right:0;bottom:0;padding:20px clamp(16px,4vw,40px);z-index:30;display:flex;justify-content:center;}
    .cta-inner{max-width:min(92ch,96vw);background:var(--text-bg);backdrop-filter:saturate(120%) blur(6px);padding:14px 18px;border-radius:12px;line-height:1.35;transform:translateY(12px);opacity:0;transition:transform var(--fade-duration) ease,opacity var(--fade-duration) ease}
    .cta.visible .cta-inner{opacity:1;transform:translateY(0)}

    @media (prefers-reduced-motion: reduce){
      .spinner{animation:none}
      .logo,.reveal,.loader,.cta-inner{transition:none}
    }
  </style>
</head>
<body>
  <div class="stage">
    <!-- Loader -->
    <div class="loader" id="loader" aria-live="polite" aria-busy="true">
      <div class="spinner" role="status" aria-label="Загрузка"></div>
    </div>

    <!-- Tap-to-play (если автоплей заблокирован) -->
    <div class="tap" id="tap">
      <div class="tap-btn" id="tapBtn">Нажмите, чтобы запустить видео</div>
    </div>

    <!-- Background video -->
    <video
      id="heroVideo"
      class="bg-video"
      preload="auto"
      playsinline
      muted
      autoplay
      poster="poster.jpg"
    >
      <source src="back1.mp4" type="video/mp4" />
      <!-- <source src="back1.webm" type="video/webm" /> -->
      Ваш браузер не поддерживает видео тег.
    </video>

    <!-- Freeze-frame canvas -->
    <canvas id="freezeCanvas" class="freeze"></canvas>

    <!-- Center logo -->
    <div class="logo" id="logo" aria-hidden="true">
      <img src="logo_trans.png" alt="Логотип" id="logoImg" />
    </div>

    <!-- Reveal image -->
    <div class="reveal" id="reveal" style="background-image:url('flow.png')"></div>

    <!-- Bottom text -->
    <div class="cta" id="cta"><div class="cta-inner">
      <strong>Дорогая Диана</strong><br/>
      Я очень сильно тебя люблю и всецело верю в тебя и все твои начинания! Я хочу чтобы тебе сопутствовала удача и я стараюсь и буду стараться тебе как-то облегчить нагрузку, потому что ощущаю свою причастность и большое желание тебе помогать чем могу и как умею!))
    </div></div>
  </div>

  <script>
    (function(){
      const video = document.getElementById('heroVideo');
      const loader = document.getElementById('loader');
      const tap = document.getElementById('tap');
      const tapBtn = document.getElementById('tapBtn');
      const logo = document.getElementById('logo');
      const reveal = document.getElementById('reveal');
      const cta = document.getElementById('cta');
      const freezeCanvas = document.getElementById('freezeCanvas');

      let logoTimer = null;
      let logoShown = false;
      let interacted = false;
      let froze = false;
      let hasStarted = false; // <- после старта спиннер больше не показываем

      /* ---------- helpers ---------- */
      // Показ спиннера только пока не стартовало
      const showLoader = () => { if(!hasStarted) loader.classList.remove('hidden'); };
      const hideLoader = () => loader.classList.add('hidden');

      function scheduleLogo(){
        if(logoShown) return;
        clearTimeout(logoTimer);
        logoTimer = setTimeout(()=>{
          logo.classList.add('visible');
          logoShown = true;
        }, getDelay());
      }

      function getDelay(){
        const styles = getComputedStyle(document.documentElement);
        const val = styles.getPropertyValue('--reveal-delay').trim();
        const ms = parseInt(val);
        return Number.isFinite(ms) ? ms : 5500;
      }

      // Маркируем, что воспроизведение реально пошло
      function markStarted(){
        if (hasStarted) return;
        if (video.currentTime <= 0.02) return; // убедимся, что тайм реально двинулся
        hasStarted = true;
        hideLoader();
        tap.classList.remove('visible');
        scheduleLogo();
        // На всякий случай уберём любые обработчики, которые могли бы снова показать лоадер
        ['waiting','stalled','suspend','emptied'].forEach(ev=>{
          video.removeEventListener(ev, showLoader);
        });
      }

      /* ---------- autoplay attempt ---------- */
      async function ensurePlayback(){
        showLoader();
        try {
          await video.play();
        } catch(e){
          // автоплей заблокирован — даём тап
          tap.classList.add('visible');
        }
      }

      // Ранний старт
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        ensurePlayback();
      } else {
        window.addEventListener('DOMContentLoaded', ensurePlayback, {once:true});
      }

      // Пользовательский «пинок»
      const userKick = async ()=>{
        if (hasStarted) return; // уже идёт — не трогаем
        showLoader();
        try{ await video.play(); }catch(e){}
      };
      tapBtn.addEventListener('click', userKick);
      // На всякий случай – первый клик/тач/клавиша
      ['click','touchstart','keydown'].forEach(ev=>{
        document.addEventListener(ev, userKick, {once:true, passive:true});
      });

      /* ---------- прячем лоадер ТОЛЬКО на первом реальном старте ---------- */
      video.addEventListener('playing', markStarted);      // когда декодер реально начал
      video.addEventListener('timeupdate', markStarted);   // страховка для некоторых браузеров

      // ВАЖНО: больше не показываем лоадер после старта — поэтому закомментировано:
      // video.addEventListener('waiting', showLoader);
      // video.addEventListener('stalled', showLoader);
      // video.addEventListener('suspend', showLoader);
      // video.addEventListener('emptied', showLoader);

      // Если вкладка вернулась – не трогаем лоадер, просто пытаемся продолжить
      document.addEventListener('visibilitychange', ()=>{
        if (!document.hidden && video.paused && !froze) {
          video.play().catch(()=>{});
        }
      });

      /* ---------- freeze last frame ---------- */
      video.addEventListener('timeupdate', ()=>{
        if(froze) return;
        const nearEnd = video.duration && (video.currentTime >= video.duration - 0.06);
        if(nearEnd){ freezeLastFrame(); froze = true; }
      });
      video.addEventListener('ended', ()=>{ if(!froze) { freezeLastFrame(); froze = true; } });

      function freezeLastFrame(){
        try{
          const w = video.videoWidth || window.innerWidth;
          const h = video.videoHeight || window.innerHeight;
          freezeCanvas.width = w; freezeCanvas.height = h;
          const ctx = freezeCanvas.getContext('2d');
          ctx.drawImage(video, 0, 0, w, h);
          freezeCanvas.style.display = 'block';
          video.pause();
        }catch(e){}
      }

      /* ---------- reveal & back ---------- */
      logo.addEventListener('click', ()=>{
        if(interacted) return; interacted = true;
        logo.classList.add('fading');
        setTimeout(()=>{ logo.style.display = 'none'; }, 700);
        reveal.classList.add('visible');
        cta.classList.add('visible');
      });

      function resetToStart(){
        reveal.classList.remove('visible');
        cta.classList.remove('visible');
        logo.style.display = '';
        logo.classList.remove('fading');
        requestAnimationFrame(()=> logo.classList.add('visible'));
        interacted = false;
        // остаёмся на замороженном последнем кадре; при желании можно перезапускать видео:
        // froze = false; freezeCanvas.style.display = 'none'; video.currentTime = 0; ensurePlayback(); logoShown = false; hasStarted = false; showLoader();
      }
      reveal.addEventListener('click', resetToStart);
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') resetToStart(); });

      /* ---------- responsive redraw of canvas ---------- */
      window.addEventListener('resize', ()=>{
        if(freezeCanvas.style.display === 'block'){
          try{
            const w = video.videoWidth || window.innerWidth;
            const h = video.videoHeight || window.innerHeight;
            freezeCanvas.width = w; freezeCanvas.height = h;
            const ctx = freezeCanvas.getContext('2d');
            ctx.drawImage(video, 0, 0, w, h);
          }catch(e){}
        }
      });
    })();
  </script>
</body>
</html>
